---
lab:
    title: 'Azure ネットワーク セキュリティ グループ (NSG) の詳細を確認する'
    module: 'モジュール 3 レッスン 1: Microsoft セキュリティ ソリューションの機能を説明する: Azure の基本的なセキュリティ機能について説明する。'
---


# ラボ: Azure ネットワーク セキュリティ グループ (NSG) の詳細を確認する

## ラボ シナリオ
このラボでは、Azure のネットワーク セキュリティ グループの機能を詳細を確認します。  ネットワーク セキュリティ グループ (NSG) のない状態で VM を作成して、これを行います。  トラフィックをフィルター処理する NSG がない状態では、VM のすべてのポートがパブリック インターネットに公開されます。  次に NSG の作成と VM のインターフェイスをその NSG に割り当てるプロセス実施します。  構成した後、既定の NSG 規則や作成した規則を使用して、VM への接続をテストします。
  

**予想時間**: 15 ～ 20 分

#### タスク 1:  このタスクでは、Windows 10 仮想マシン を作成します。    
1.	Microsoft Edge を開きます。  アドレス バーに、「**portal.azure.com**」 と入力します。

1. 管理者の資格情報でサインインします。
    1. 「サインイン」ウィンドウで、「**admin@WWLxZZZZZZ.onmicrosoft.com**」 (ZZZZZZ はラボ ホスティング プロバイダーにより提供される一意のテナント ID です) を入力してから、「**次へ**」を選択します。

    1. ラボ ホスティング プロバイダーから提供される管理者のパスワードを入力します。「**サインイン**」を選択します。
    1. サインインしたままにするかどうかを尋ねられたら、「**はい**」を選択します。
1. Microsoft Azure の隣の画面の左上隅で、「ポータル メニューの表示」アイコン (3 本の水平方向のラインのあるアイコンで、「ハンバーガー」アイコンとも呼ばれます) を選択してから、「**すべてのサービス**」を選択します。  
1. 「メイン」ウィンドウの「特集」の下で、「仮想マシン」を選択します。  仮想マシンが一覧表示されない場合は、検索バーに仮想マシンと入力し、検索結果から選択します。
1. ページの左上で、「**+ 作成**」を選択してから、「**+ 仮想マシン**」を選択します。
1. 「基本」タブで、次の情報を入力します (一覧表示されていない場合は、既定の設定のままにします)。
    1. サブスクリプション: Azure Pass - スポンサーシップが既定の設定であることを確認します。

    1. リソース グループ:  「**新規作成**」 を選択してから、「名前」フィールドに 「**LabsSC900**」 と入力し、その後、「**OK**」を選択します。
    1. 仮想マシン名:  「**SC900-WinVM**」と入力します。
    1. イメージ:  ドロップダウンから、「**Windows 10 Pro、バージョン 20H2 – Gen 1**」 を選択します。
    1. サイズ:  ドロップダウンから、「**すべてのサイズを表示**」を選択し、「**B2s**」を選択してから、ページの下部で、「**選択**」を押します。
    1. ユーザー名:  「**AzureUser**」と入力します。
    1. パスワード:  「**SC900AzureLabs**」と入力します。
    1. パブリック インバウンド ポート:  「**なし**」 を選択します。
    1. ライセンス:  「**私はマルチテナント ホスト権限のある適格な Windows 10 ライセンスを持っていることを確認します**」を選択し、ボックスにチェックマークが表示されるようにします。
    1. 「**次へ: ディスク**」を選択します。 
1. 現在、VM 構成の「ディスク」タブが表示されています。  すべての設定を既定のままにてい、「**次へ: ネットワーク >**」を選択します。
1. 現在、VM 構成の「ネットワーク」タブが表示されています。  次の情報を入力します (一覧表示されていない場合は、既定の設定のままにします)。
    1. NIC ネットワーク セキュリティ グループ:  「**なし**」 を選択します。

    1. 「**次へ:  管理 >**」を選択します。
1. 現在、VM 構成の「管理」タブが表示されています。  すべての設定を既定のままにてい、「**次へ: 詳細 >**」 を選択します。
1. 現在、VM 構成の「詳細」タブが表示されています。  すべての設定を既定のままにてい、「**次へ: タグ >**」 を選択します。
1. 現在、VM 構成の「タグ」タブが表示されています。  すべての設定を既定のままにてい、「**次へ: Review + Create>**」 を選択します。
1. VM の構成を確認します。  いくつかの注意点があります。この VM には、パブリック IP アドレスがありますが、NIC ネットワーク セキュリティ グループはありません。  セキュリティの観点から、これにより、VM は公開された状態になります。  以降のタスクでこれに対処します。「作成」を選択します。  VM のデプロイが完了するまでに数分かかる場合があります。
1. ネットワーク インターフェイスの名前 **sc900-winvmXXX** (XXX は VM のネットワーク インターフェイスに対して固有となります) をメモします。
1. VM のデプロイが完了したら、「**リソースに移動**」を選択します。
1. 「SC900-WinVM」ページに移動します。  パブリック IP アドレスをメモします。 
1. ページの上部で、「**接続**」を選択してから、ドロップダウンで、「**RDP**」 を選択します。
1. IP アドレスがパブリック IP アドレスに設定されていることを確認し、既定のポート番号のままにして、「**DRP ファイルのダウンロード**」 を選択します。 
1. ダウンロードしたファイルを開き、「**接続**」を選択します。 
1. 資格情報の入力を求められます。  「ユーザー名」には、「**AzureUser**」 と入力します。  「パスワード」には、「**SC900AzureLabs**」 と入力します。 
1. リモート デスクトップ 接続ウィンドウが、「リモート コンポーネントの ID を確認できません。  とにかく世俗しますか?」というメッセージと共に開きます。  「**はい**」 を選択します。
1. 現在、作成したばかりの Windows VM に接続しています。プロンプトに従い、Windows セットアップを完了します。RDP を介して VM に接続し、通常は RDP ポートを使用していましたが、この VM はすべてのポートが開いており、トラフィックのフィルター処理を行っていません。 
1. IP アドレスが表示されるページの上中央の 「**X**」 を選択して、リモート デスクトップ接続を閉じます。  ポップアップ ウィンドウに「リモート セッションが閉じられた」ことが表示されます。「**OK**」を選択します。
1. Azure portal の「SC900-WinVM」に戻ります。  次のタスクのために、このブラウザー タブを開いたままにします。

#### タスク 2:  ネットワーク セキュリティ グループを作成し、VM のネットワーク インターフェイスをその NSG に割り当てます。

1. ブラウザーで、「SC900-WinVM – Microsoft Azure」タブを開きます。

1. Microsoft Azure の隣のページの左上隅で、「ポータル メニューの表示」アイコン (3 本の水平方向のラインのあるアイコンで、「ハンバーガー」アイコンとも呼ばれます) を選択してから、「**すべてのサービス**」を選択します。
1. 「すべてのサービス」の隣の「フィルター サービス」ボックスで、「**ネットワーク セキュリティ グループ**」 と入力し、結果から、「**ネットワーク セキュリティ グループ**」 を選択します (ネットワーク セキュリティ グループ クラシックを選択しないでください)。
1. 「ネットワーク セキュリティ グループ」ページで、「**+ 作成**」 を選択します。
1. 「ネットワーク セキュリティ グループの作成」ページの「基本」タブで、次の設定を指定します。
    1. サブスクリプション:  Azure Pass – スポンサーシップ

    1. リソース グループ:  **LabsSC900**
    1. 名前:  **NSG-SC900**
    1. リージョン:  既定の「**米国東部**」のままにします
    1. 「**Review + create**」 を選択してから、「**作成**」を選択します。
1. デプロイが完了したら、「**リソースに移動**」 を選択します。
1. NSG の既定の受信および送信規則に注意してください。  NSG が作成されましたが、トラフィックをフィルター処理するための既定の規則があり、NSG にインターフェイスが関連付けられていません。そのため、VM はすべてのポートがパブリック インターネットに対して公開されており、脆弱なままです。
1. 「NSG-SC900」ページの「左ナビゲーション」ペインの「設定」の下で、「**ネットワーク インターフェイス**」を選択します。
1. 上の「検索」ボックスでで、「**+ 関連付け**」 を選択します。
1. 「ネットワーク インターフェイスの関連付け」ページで、「**sc900-winvmXXX**」 を選択します (XXX は VM のネットワーク インターフェイスに対して固有です)。  インターフェイスが関連付けられると、画面の右上隅に通知ボックスが表示されます。
1. インターフェイスが NSG に関連付けられると、一覧に表示されます。
1. VM インターフェイスがネットワーク セキュリティ グループと既定の NSG 規則に割り当てられた状態では、VM への接続の試みは失敗するはずです。  
1. ページの左上隅で、「**すべてのサービス**」を選択してから、「特集」の下で、「**仮想マシン**」を選択します。
1. 「仮想マシン」ページで、「**SC900-WinVM**」を選択します。
1. 「**SC900-WinVM**」ページの上部で、「**接続**」を選択してから、「**RDP**」を選択します。
1. IP アドレスがパブリック IP アドレスに設定されていることを確認し、既定のポート番号のままにして、「**DRP ファイルのダウンロード**」を選択します。
1. ダウンロードしたファイルを開き、「**接続**」を選択します。
1. 接続を試みてから数秒後、「リモート デスクがリモート コンピューターに接続できない」ことを示す失敗メッセージが表示されます。  「**OK**」を選択します。

#### タスク 3: このタスクでは、ポート 3389 上の RDP を使用する受信トラフィックを許可する NSG 規則を作成します。  次に、RDP を使用して VM への接続を試みて、その規則をテストします。 

1. ブラウザーで、「SC900-WinVM – Microsoft Azure」タブを開きます。

1. 左ナビゲーション パネルで、「設定」の下の「**ネットワーク**」を選択します。
1. 「受信ポート規則」タブが選択された状態では、既定の受信規則が表示されます。既定の規則を削除することはできませんが、優先度の高い新しい規則を作成することで規則をオーバーライドできます。ページの右側で、「**受信ポート規則の追加**」を選択します。
1. 「受信セキュリティ規則の追加」ページで、次の情報を入力します。
    1. ソース:  **指定なし**

    1. 送信元ポートの範囲: *
    1. 宛先:  **指定なし**
    1. サービス:  **RDP**
    1. アクション:  **許可**
    1. 優先度:  **300**。 注: 小さい数字の規則は高い優先順位を持ち、最初に処理されます。
    1. 名前:  **AllowRDP**
1. 「**追加**」を選択します
1. 規則がプロビジョニングされると、受信規則の一覧に表示されます。
1. RDP を使用して、VM に接続できることを確認します。  左ナビゲーション パネルで、「**接続**」を選択します。
1. IP アドレスがパブリック IP アドレスに設定されていることを確認し、既定のポート番号のままにして、「**DRP ファイルのダウンロード**」 を選択します。
1. ダウンロードしたファイルを開き、「**接続**」を選択します。
1. 資格情報の入力を求められます。  「ユーザー名」には、「**AzureUser**」と入力します。  「パスワード」には、「**SC900AzureLabs**」 と入力します。
1. リモート デスクトップ 接続ウィンドウが、「リモート コンポーネントの ID を確認できません。  とにかく世俗しますか?」というメッセージと共に開きます。  「**はい**」 を選択します。
1. これで、VM に接続されました。VM に接続できた場合、これは作成した受信トラフィック規則が RDP を介する VM への受信トラフィックを許可していたためです。
1. 次のタスクで使用するため、VM を開いたままにしておきます。

#### タスク 4:  NSG の既定の送信規則は、送信インターネット トラフィックを許可しているため、インターネットに接続できることを検証します。  次に、送信インターネット トラフィックをブロックするカスタム送信規則を作成するプロセスを行い、その規則をテストします。

1. VM から、「**Microsoft Edge**」を選択して、ブラウザーを開きます。  
1. ブラウザーのアドレス バーに **https://www.bing.com** と入力して、検索エンジンに接続できることを確認します。
1. VM のブラウザーを閉じます。しかし、後続の手順を使用するため、VM は開いたままにします。
1. Azure portal に戻り、ブラウザーで、「SC900-WinVM – Microsoft Azure」タブを開きます。
1. 左ナビゲーション パネルで、「設定」の下の「**ネットワーク**」を選択します。
1. 「**送信ポート規則**」タブを選択します。  既定の送信規則が表示されます。  既定の規則は "AllowInternetOutBound" です。この規則は、すべての送信インターネット トラフィックを許可します。既定の規則を削除することはできませんが、優先度の高い新しい規則を作成することで規則をオーバーライドできます。ページの右側で、「**送信ポート規則の追加**」を選択します。
1. 「送信セキュリティ規則の追加」ページで、次の情報を入力します。
    1. ソース:  **指定なし**

    1. 送信元ポートの範囲:  *
    1. 宛先:  **サービス タグ**
    1. 宛先サービス タグ:  **インターネット**
    1. サービス:  **カスタム** (既定のままにします)
    1. 宛先ポート範囲:  * (宛先ポート範囲フィールドに必ずアスタリスクを入力してください)
    1. プロトコル: **指定なし**
    1. アクション: **Deny**
    1. 優先度:  **4000**
    1. 名前:  **DenyInternet**
1. 「**追加**」 を選択します
1. 規則がプロビジョニングされると、送信規則の一覧に表示されます。  一覧に表示されますが、有効になるまで数分かかります (次の手順を続行する前に数分間待機します)。  
1. VM に戻ります
1. VM で Microsoft Edge を開き、**https://www.bing.com** と入力します。  ページは表示されません。  注: インターネットに接続でき、送信規則のすべてのパラメーターが適切に設定されていたことを確認した場合、これは規則が有効になるまで数分かかることによる可能性があります。  ブラウザーを閉じ、しばらく待ってから再試行してください。
1. IP アドレスが表示されるページの上中央の「**X**」を選択して、リモート デスクトップ接続を閉じます。  ポップアップ ウィンドウに「リモート セッションが閉じられた」ことが表示されます。「**OK**」を選択します。
1. このタスクでは、NSG で送信規則を正常に構成し、送信インターネット トラフィックをブロックしました。

#### タスク 5:  重要: このタスクでは、リソース グループとそれに含まれるすべてのリソースが削除されます。   これは、追加料金を避けるために重要です。

1. ブラウザーで、「SC900-WinVM – Microsoft Azure」タブを開きます。

1. ページの左下隅で、「**すべてのサービス**」 を選択します。
1. 「すべてのサービス」の隣の「フィルター サービス」ボックスで、「**リソース グループ**」 と入力し、結果から、「**リソース セキュリティ グループ**」 を選択します。
1. 「**LabsSC900**」を選択します。
1. 「LabsSC900」ページの中央上で、 「**リソース グループの削除**」 を選択します。
1. 開くウィンドウで、リソース グループ名 「**LabsSC900**」 を入力して、リソース グループとそのすべてのリソースの削除を確認してから、ページの下部で、 「**削除**」 を選択します。
1. すべてのリソースとリソース グループが削除されるまで数分かかる場合があります。

#### レビュー

このラボでは、ネットワーク セキュリティ グループ (NSG) がありおよびなしの状態で VM を設定し、既定の NSG 規則の影響を確認するプロセスを詳しく説明しました。  また、NSG 規則を作成するプロセスを詳しく説明しました。
